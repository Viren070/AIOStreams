name: Sync Upstream

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    concurrency:
      group: sync-upstream-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: write
      issues: write
      id-token: write
      actions: write
      workflows: write
    env:
      UPSTREAM_REPO: Viren070/AIOStreams
      UPSTREAM_BRANCH: main
      MIRROR_BRANCH: upstream-main
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          if ! git remote get-url upstream >/dev/null 2>&1; then
            git remote add upstream https://github.com/${UPSTREAM_REPO}.git
          fi
          # Force tag updates to avoid "would clobber existing tag" failures
          git fetch upstream ${UPSTREAM_BRANCH} --tags --force

      - name: Update upstream-main mirror
        env:
          TOKEN: ${{ secrets.PAT_TOKEN || github.token }}
        run: |
          git remote remove origin
          git remote add origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git
          git checkout -B ${MIRROR_BRANCH} upstream/${UPSTREAM_BRANCH}
          git push origin ${MIRROR_BRANCH} --force

      - name: Rebase main onto upstream
        env:
          TOKEN: ${{ secrets.PAT_TOKEN || github.token }}
        run: |
          git remote remove origin
          git remote add origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git
          git fetch origin main
          git checkout main
          if git merge-base --is-ancestor upstream/${UPSTREAM_BRANCH} main; then
            echo "Main already contains upstream."
            exit 0
          fi
          if ! git rebase --strategy-option=theirs upstream/${UPSTREAM_BRANCH}; then
            git rebase --abort || true
            echo "Rebase failed. Resolve conflicts manually."
            exit 1
          fi
          git push origin main --force-with-lease=main

      - name: Open issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = `Upstream sync failed: run ${context.runId}`;
            const label = 'sync-failed';
            const body = [
              `Workflow: ${context.workflow}`,
              `Run: https://github.com/${owner}/${repo}/actions/runs/${context.runId}`,
              '',
              'Rebase failed while syncing upstream. Please resolve conflicts on `main` and re-run.',
            ].join('\n');

            // Ensure label exists
            try {
              await github.rest.issues.getLabel({ owner, repo, name: label });
            } catch (error) {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: label,
                color: 'd73a4a',
                description: 'Upstream sync failures',
              });
            }

            // Avoid duplicate open issues
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: label,
            });

            if (issues.some((issue) => issue.title.startsWith('Upstream sync failed:'))) {
              return;
            }

            await github.rest.issues.create({ owner, repo, title, body, labels: [label] });
